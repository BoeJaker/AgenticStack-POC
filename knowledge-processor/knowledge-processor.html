<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Knowledge Graph - Offline Semantic</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
body {margin:0;padding:20px;font-family:'Segoe UI',sans-serif;background:#1e1e2f;color:white;}
.container {max-width:1400px;margin:0 auto;background: rgba(255,255,255,0.05);padding:30px;border-radius:15px;}
textarea {width:100%;height:120px;background: rgba(255,255,255,0.1);color:white;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);}
button {margin-top:10px;padding:10px 20px;border:none;border-radius:20px;cursor:pointer;background:#4ecdc4;color:white;font-weight:bold;}
#graph {width:100%;height:600px;background: rgba(0,0,0,0.2);border-radius:10px;margin-top:20px;}
.node-label {text-anchor:middle;fill:white;font-size:12px;pointer-events:none;}
.tooltip {position:absolute;background:rgba(0,0,0,0.9);color:white;padding:8px;border-radius:5px;font-size:12px;pointer-events:none;opacity:0;transition:opacity 0.3s;}
</style>
</head>
<body>
<div class="container">
<h1>ðŸ§  Knowledge Graph Processor (Offline Semantic)</h1>
<textarea id="textInput" placeholder="Enter text here..."></textarea>
<br>
<button onclick="processText()">ðŸ”„ Process Text</button>
<button onclick="loadSampleData()">ðŸ“Š Load Sample</button>
<div id="graph"></div>
<div class="tooltip" id="tooltip"></div>
</div>

<script>
let currentData = {nodes:[], links:[]};
let simulation;

// -------------------- Sample Data --------------------
function loadSampleData(){
    const text = `Apple Inc. was founded by Steve Jobs and Steve Wozniak in 1976. Tim Cook became CEO in 2011. Apple develops the iPhone, iPad, and Mac computers. Microsoft was founded by Bill Gates in 1975. Satya Nadella is CEO. Google was founded by Larry Page and Sergey Brin in 1998. Google is now part of Alphabet Inc.`;
    document.getElementById('textInput').value = text;
    processText();
}

// -------------------- Text Processing --------------------
async function processText(){
    const text = document.getElementById('textInput').value;
    if(!text.trim()) return;

    // Fetch entities and relations from local server
    const entities = await fetch("http://localhost:8000/ner", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text})}).then(r=>r.json());
    const relations = await fetch("http://localhost:8000/relations", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text})}).then(r=>r.json());

    // Build nodes
    const nodes = entities.map((e,i)=>({
        id:`n${i}`,
        name:e.name,
        type:e.type,
        group:getGroupByType(e.type),
        size: Math.random()*20+15,
        value:e.value
    }));

    // Build links from relations
    const links = [];
    relations.forEach(r=>{
        const sourceNode = nodes.find(n=>n.name===r.source);
        const targetNode = nodes.find(n=>n.name===r.target);
        if(sourceNode && targetNode){
            links.push({source: sourceNode.id, target: targetNode.id, type:r.type, strength: Math.random()*0.8+0.2});
        }
    });

    // Chronological links for years
    const yearNodes = nodes.filter(n=>n.type==="DATE").sort((a,b)=>parseInt(a.name)-parseInt(b.name));
    for(let i=0;i<yearNodes.length-1;i++){
        links.push({source:yearNodes[i].id, target:yearNodes[i+1].id, type:"chronological", strength:0.1});
    }

    currentData = {nodes, links};
    updateVisualization();
}

// -------------------- Utility --------------------
function getGroupByType(type){
    const map = { PER:1, ORG:2, LOC:3, MISC:4, DATE:5 };
    return map[type]||0;
}

// -------------------- D3 Visualization --------------------
function updateVisualization(){
    d3.select("#graph").select("svg").remove();
    const width = document.getElementById('graph').clientWidth;
    const height = document.getElementById('graph').clientHeight;
    const svg = d3.select("#graph").append("svg").attr("width",width).attr("height",height);
    const zoomLayer = svg.append("g");
    svg.call(d3.zoom().scaleExtent([0.3,3]).on("zoom", event=>zoomLayer.attr("transform", event.transform)));
    const color = d3.scaleOrdinal([0,1,2,3,4,5,6]).range(['#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#feca57','#ff9ff3','#54a0ff']);

    simulation = d3.forceSimulation(currentData.nodes)
        .force("link", d3.forceLink(currentData.links).id(d=>d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width/2,height/2))
        .force("collision", d3.forceCollide().radius(d=>d.size+5));

    const link = zoomLayer.append("g").selectAll("line").data(currentData.links).join("line")
        .attr("stroke","#999").attr("stroke-opacity",0.6).attr("stroke-width",d=>Math.sqrt(d.strength*5)+1)
        .on("mouseover",(event,d)=>{ showTooltip(event,`${d.type}: ${d.source} â†’ ${d.target}`); })
        .on("mouseout", hideTooltip);

    const node = zoomLayer.append("g").selectAll("circle").data(currentData.nodes).join("circle")
        .attr("r",d=>d.size).attr("fill",d=>color(d.group))
        .on("mouseover",(event,d)=>showTooltip(event,d.name))
        .on("mouseout", hideTooltip)
        .call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended));

    const labels = zoomLayer.append("g").selectAll("text").data(currentData.nodes).join("text")
        .attr("class","node-label").attr("dy","0.31em")
        .text(d=>d.name.length>12?d.name.substring(0,12)+"...":d.name);

    simulation.on("tick", ()=>{
        link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y).attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
        node.attr("cx",d=>(d.x=Math.max(d.size,Math.min(width-d.size,d.x)))).attr("cy",d=>(d.y=Math.max(d.size,Math.min(height-d.size,d.y))));
        labels.attr("x",d=>d.x).attr("y",d=>d.y);
    });

    function dragstarted(event,d){ if(!event.active) simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
    function dragged(event,d){ d.fx=event.x; d.fy=event.y; }
    function dragended(event,d){ if(!event.active) simulation.alphaTarget(0); d.fx=null; d.fy=null; }
}

// -------------------- Tooltip --------------------
function showTooltip(event,text){ const t=document.getElementById('tooltip'); t.style.opacity=1; t.style.left=(event.pageX+10)+'px'; t.style.top=(event.pageY-10)+'px'; t.textContent=text; }
function hideTooltip(){ document.getElementById('tooltip').style.opacity=0; }

</script>
</body>
</html>
